
<div id="game">	
	<canvas id="pcanvas" width="700" height="700"></canvas>	
</div>

<div id="gameInfos">
    <span class="title">
    Infos
    </span>
    <div class="section">
        <div class="circle"></div>
        <span id="player1" class="player">Joueur 1</span>
        <span class="versus">vs</span>
        <span id="player2" class="player">Joueur 2</span>
        <hr>
    </div>
    <div class="section">
        <div class="whoplays">
            <span id="information">C'est Ã  vous de jouer</span>
        </div>
        <hr>
    </div>
    <div class="section">
        <button class="red" id="ff">
            <span>Abandonner</span>
        </button>
    </div>
</div>


<script>

/*
* debug
*/
$(".selector").addClass("hide");

//fin debug
function resize(){
	var height = $(document).height();
	var top = (height-$("canvas").height()) / 2;
	var width = $(document).width();
	var left = (width-($("canvas").width()+250))/2;
	$(".loader").css("top", top);

	$("#gameInfos").css("margin-left", $("canvas").width());
	$("canvas").css("left", left);
	$("#gameInfos").css("left", left);
	console.log(top);
}
 
resize();
window.onresize = function() {
 	resize();
};
$("#player1").html(localStorage.name);
var NUMBER_CELL = 7;
var canvas = document.getElementById("pcanvas");	
var ctx = canvas.getContext("2d");
var sizeCell = canvas.height/NUMBER_CELL;
var yourTurn = false;
var audio = new Audio('token.wav');
var canvasPosition = {x:0,y:0};
var tokens = [];
var backgroundCell = new Image();
backgroundCell.src = 'pcell.png';

function initializeGame(){
	for(i = 0; i<NUMBER_CELL; i++){
		tokens[i] = []
		for(j = 0; j<NUMBER_CELL; j++){
			tokens[i][j] = null;
		}
	}
	requestAnimationFrame(draw);
}

function draw(timestamp){	
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	ctx.fillStyle = "#ecf0f1";
	ctx.fillRect(0,0,canvas.width, canvas.height)
	
	for(i = 0; i<NUMBER_CELL; i++){
		for(j = 0; j<NUMBER_CELL; j++){
			if(tokens[i][j] !=null){
				tokens[i][j].draw(timestamp);
			}
		}
	}

	for(i = 0; i<NUMBER_CELL; i++){
		for(j = 0; j<NUMBER_CELL; j++){
			ctx.drawImage(backgroundCell,i*sizeCell+canvasPosition.x,j*sizeCell+canvasPosition.y,sizeCell,sizeCell);
		}
	}

	requestAnimationFrame(draw);
};


function playToken(column){
	for(i = 0; i<NUMBER_CELL; i++){
		if(tokens[column][i]==null){
			tokens[column][i] = new Token(column, i);
			return;
		}
	}
}

function getColumn(e){
	var rect = canvas.getBoundingClientRect();
	var x = ((e.clientX - rect.left)/(rect.right - rect.left)*canvas.width) - canvasPosition.x;		
	var column = Math.floor(x/sizeCell);
	if(column == null || column<0 || column >(NUMBER_CELL-1)){
		return false
	}

	return column;
}


function Token(column,line){

	var column = column;
	var line = line;
	var x = column*sizeCell;
	var yStart = -sizeCell;
	var yFinal = sizeCell*NUMBER_CELL - line*sizeCell - sizeCell;
	var yTmp = yStart;
	var start = null;
	var progress = null;
	var duration = 800;
	var token = null;


	if(Token.count%2==0){
		token = Token.redToken;
	}else{
		token = Token.yellowToken;
	}
	Token.count++;

	this.draw = function(timestamp){
		if(start === - 1){
			ctx.drawImage(token,x+canvasPosition.x,yFinal+canvasPosition.y,sizeCell,sizeCell);
			return;
		}
		if(start===null) start = timestamp;
		progress = timestamp - start;
		ratio = progress / duration;

		if(progress>duration){
			start = -1;
			ctx.drawImage(token,x+canvasPosition.x,yFinal+canvasPosition.y,sizeCell,sizeCell);
			audio.play();
		}else{
			ctx.drawImage(token,x+canvasPosition.x,yStart+(yFinal-yStart)*ratio+canvasPosition.y,sizeCell,sizeCell);
		}
		
	}
}
Token.redToken = new Image();
Token.redToken.src = 'redToken.png';
Token.yellowToken = new Image();
Token.yellowToken.src = 'yellowToken.png';
Token.count = 0;




$(document).ready(function() {
	$(document).on("click", "#pcanvas", function(e) {
		//play(e);
		if(!game.yourTurn){
			return;
		}
		var column = getColumn(e);
		if(column){
			socket.getSocket().emit("puissance quatre",column);	
		}
			
	});
});




socket.getSocket().on("puissance quatre", function(data){	
	game.yourTurn = data.yourTurn;
	$("#player1").html(data.player1);
	$("#player2").html(data.player2);
	if(data.winner!=-1){
		game.yourTurn = false;
		$("#information").html(data.winner+" gagne la partie.");
	}
	if(data.column!=-1){
		playToken(data.column);
	}
	
})

initializeGame();
	
</script>