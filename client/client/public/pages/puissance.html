
<div id="game">	
	<canvas id="pcanvas" width="750" height="750"></canvas>

</div>

<div class="button" id="home">Accueil</div>

<script>

function Game(){

	var grid = new Grid(this);
	this.yourTurn = false;

	this.getGrid = function(){
		return grid;
	};

}
Game.audio = new Audio('token.wav');

function Grid(g){

	var i =0, j=0;
	var game = g;
	var canvas = document.getElementById("pcanvas");	
	var ctx = canvas.getContext("2d");
	var size = canvas.height;
	var sizeCell = size/7;
	var position = {x:0,y:0};
	var tokens = [];
	for(i = 0; i<7; i++){
		tokens[i] = []
		for(j = 0; j<7; j++){
			tokens[i][j] = null;
		}
	}

	this.reset = function(){
		for(i = 0; i<7; i++){
			tokens[i] = []
			for(j = 0; j<7; j++){
				tokens[i][j] = null;
			}
		}
	}


	this.draw = function(){
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx.fillStyle = "#ecf0f1";
		ctx.fillRect(0,0,canvas.width, canvas.height)
		for(i = 0; i<7; i++){
			for(j = 0; j<7; j++){
				if(tokens[i][j] !=null){
					tokens[i][j].draw(ctx, position);
				}
			}
		}
		for(i = 0; i<7; i++){
			for(j = 0; j<7; j++){
				ctx.drawImage(Grid.backgroundCell,i*sizeCell+position.x,j*sizeCell+position.y,sizeCell,sizeCell);
			}
		}
	};

	this.getMouseColumn = function(e){
		var rect = canvas.getBoundingClientRect();
		var x = e.clientX - rect.left - position.x;		
		var column = Math.floor(x/sizeCell);
		if(column<0 || column >6){
			return false
		}
		return column;
	}

	this.addToken = function(column){
		for(i = 0; i<7; i++){
			if(tokens[column][i]==null){
				tokens[column][i] = new Token(column, i, sizeCell);
				return;
			}
		}
	}

}
Grid.backgroundCell = new Image();
Grid.backgroundCell.src = 'pcell.png';

function Token(column,line,size){

	var column = column;
	var line = line;
	var size = size;
	var x = column*size;
	var yStart = -size;
	var yFinal = size*7 - line*size - size;
	var yTmp = yStart;
	var animation = true;
	var token = null;

	if(Token.count%2==0){
		token = Token.redToken;
	}else{
		token = Token.yellowToken;
	}
	Token.count++;

	this.draw = function(ctx, position){
		ctx.drawImage(token,x+position.x,yTmp+position.y,size,size);
		if(animation){
			yTmp = yTmp + 10;
			if(yTmp>=yFinal){
				Game.audio.play();
				yTmp = yFinal;
				animation = false;
			}
		}

	}
}
Token.redToken = new Image();
Token.redToken.src = 'redToken.png';
Token.yellowToken = new Image();
Token.yellowToken.src = 'yellowToken.png';
Token.count = 0;


game = new Game();

$(document).ready(function() {
	$(document).on("click", "#pcanvas", function(e) {

		if(!game.yourTurn){
			return;
		}

		var column = game.getGrid().getMouseColumn(e);

		socket.getSocket().emit("puissance quatre",column);
		/*
		game.getGrid().addToken(column);
		game.getGrid().draw();
		*/
	});
});

setInterval(function(){game.getGrid().draw();}, 1);


socket.getSocket().on("puissance quatre", function(data){
	game.yourTurn = data.yourTurn;
	if(data.winner!=-1){
		game.yourTurn = false;
		console.log("le joueur "+data.winner+" gagne");
	}
	if(data.column!=-1){
		game.getGrid().addToken(data.column);
		game.getGrid().draw();
	}else{
		game.getGrid().reset();
	}
	
})
	
</script>