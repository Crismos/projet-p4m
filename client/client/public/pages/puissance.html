
<div id="game">	
	<canvas id="pcanvas" width="1000" height="700"></canvas>	
</div>

<div class="button" id="home">Accueil</div>


<script>
var NUMBER_CELL = 7;
var canvas = document.getElementById("pcanvas");	
var ctx = canvas.getContext("2d");
var sizeCell = canvas.height/NUMBER_CELL;
var yourTurn = false;
var audio = new Audio('token.wav');
var canvasPosition = {x:0,y:0};
var tokens = [];
var backgroundCell = new Image();
backgroundCell.src = 'pcell.png';

function initializeGame(){
	for(i = 0; i<NUMBER_CELL; i++){
		tokens[i] = []
		for(j = 0; j<NUMBER_CELL; j++){
			tokens[i][j] = null;
		}
	}
	requestAnimationFrame(draw);
}

function draw(timestamp){	
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	ctx.fillStyle = "#ecf0f1";
	ctx.fillRect(0,0,canvas.width, canvas.height)
	
	for(i = 0; i<NUMBER_CELL; i++){
		for(j = 0; j<NUMBER_CELL; j++){
			if(tokens[i][j] !=null){
				tokens[i][j].draw(timestamp);
			}
		}
	}

	for(i = 0; i<NUMBER_CELL; i++){
		for(j = 0; j<NUMBER_CELL; j++){
			ctx.drawImage(backgroundCell,i*sizeCell+canvasPosition.x,j*sizeCell+canvasPosition.y,sizeCell,sizeCell);
		}
	}

	requestAnimationFrame(draw);
};


function play(e){
	var rect = canvas.getBoundingClientRect();
	var x = ((e.clientX - rect.left)/(rect.right - rect.left)*canvas.width) - canvasPosition.x;		
	var column = Math.floor(x/sizeCell);
	if(column<0 || column >(NUMBER_CELL-1)){
		return false
	}

	for(i = 0; i<NUMBER_CELL; i++){
		if(tokens[column][i]==null){
			tokens[column][i] = new Token(column, i);
			return;
		}
	}
}


function Token(column,line){

	var column = column;
	var line = line;
	var x = column*sizeCell;
	var yStart = -sizeCell;
	var yFinal = sizeCell*NUMBER_CELL - line*sizeCell - sizeCell;
	var yTmp = yStart;
	var start = null;
	var progress = null;
	var duration = 800;
	var token = null;


	if(Token.count%2==0){
		token = Token.redToken;
	}else{
		token = Token.yellowToken;
	}
	Token.count++;

	this.draw = function(timestamp){
		if(start === - 1){
			ctx.drawImage(token,x+canvasPosition.x,yFinal+canvasPosition.y,sizeCell,sizeCell);
			return;
		}
		if(start===null) start = timestamp;
		progress = timestamp - start;
		ratio = progress / duration;

		if(progress>duration){
			start = -1;
			ctx.drawImage(token,x+canvasPosition.x,yFinal+canvasPosition.y,sizeCell,sizeCell);
			audio.play();
		}else{
			ctx.drawImage(token,x+canvasPosition.x,yStart+(yFinal-yStart)*ratio+canvasPosition.y,sizeCell,sizeCell);
		}
		
	}
}
Token.redToken = new Image();
Token.redToken.src = 'redToken.png';
Token.yellowToken = new Image();
Token.yellowToken.src = 'yellowToken.png';
Token.count = 0;




$(document).ready(function() {
	$(document).on("click", "#pcanvas", function(e) {
		play(e);
		/*if(!game.yourTurn){
			return;
		}*/


		//socket.getSocket().emit("puissance quatre",column);
	
		
	});
});




socket.getSocket().on("puissance quatre", function(data){	
	game.yourTurn = data.yourTurn;
	if(data.winner!=-1){
		game.yourTurn = false;
		console.log("le joueur "+data.winner+" gagne");
	}
	if(data.column!=-1){
		play(data.column);
	}
	
})

initializeGame();
	
</script>